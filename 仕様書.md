

## 1. 概要

iPadのWebブラウザ（Safari/PWA）で動作する、画像への暗記マーカー描画・学習アプリ。

Apple Pencilと指によるタッチ操作を明確に区別し、ストレスのない暗記学習環境を提供する。

## 2. 技術スタック・環境

- **Platform:** Web Application (React + TypeScript + Vite, PWA対応)
    
- **Host:** Netlify
    
- **Target Device:** iPad (Apple Pencil必須)
    
- **Storage:** IndexedDB (Dexie.js使用)
    
- **Media:** 画像データはBase64またはBlobとしてIndexedDBに保存 (JPEG/PNG)
    

## 3. データモデル（IndexedDB）

### Store: `decks` (暗記セット)

|**Key**|**Type**|**Description**|
|---|---|---|
|`id`|number (Auto Inc)|主キー|
|`title`|string|ユーザー入力タイトル|
|`createdAt`|date|作成日|
|`updatedAt`|date|更新日|

### Store: `images` (画像とマーカーデータ)

|**Key**|**Type**|**Description**|
|---|---|---|
|`id`|number (Auto Inc)|主キー|
|`deckId`|number|親となるdeckのID|
|`imageData`|blob/string|画像データ (JPEG/PNG)|
|`order`|number|表示順序|
|`markers`|array|マーカー情報の配列|

#### `markers` Array Object Structure

JSON

```
{
  "x": number,      // 親コンテナに対する相対座標(px) または %
  "y": number,
  "width": number,
  "height": number
}
```

---

## 4. 画面・機能要件

### 4.1. 画像登録フロー（モーダル/ダイアログ）

- **トリガー:** 一覧画面の「新規作成」ボタン（FAB等）
    
- **入力項目:**
    
    - タイトル（テキスト入力）
        
    - 画像選択（`<input type="file" multiple accept="image/jpeg, image/png">`）
        
- **処理:**
    
    - 複数枚のJPEG画像を選択可能。
        
    - 「保存」ボタン押下で `decks` および `images` ストアに保存し、一覧画面へ戻る。
        

### 4.2. 一覧画面（ホーム）

- **レイアウト:** グリッドまたはリスト形式のカード表示
    
- **カードの構成要素:**
    
    - **サムネイル:** 登録画像の1枚目を表示。
        
    - **タイトル:** デッキのタイトル。
        
    - **枚数:** 「全N枚」のようなバッジ表示。
        
    - **アクションエリア:**
        
        1. **学習ボタン（サムネイル自体）:** タップで「学習モード」へ遷移。
            
        2. **編集ボタン（ペンアイコン）:** タップで「編集モード」へ遷移。
            
        3. **設定ボタン（ギアアイコン）:** タップで「設定メニュー」を開く。
            

### 4.3. 編集モード（マーカー作成）

- **画面向き:** 縦・横両対応（ユーザーの持ち方に合わせる）。
    
- **表示構成:**
    
    - 画像は縦に並べて配置（スクロールで閲覧）。
        
    - 画像の上に描画レイヤー（SVG）を重ねる。
        
- **操作体系（Pointer Events）:**
    
    - **指 (Touch):** 画面全体のスクロール、ピンチイン・アウト（Zoom）のみ動作。描画は行わない。
        
    - **ペン (Pen):** 選択中のツールのアクションを実行。スクロール・Zoomは行わない。
        
- **UIコンポーネント:**
    
    - **戻るボタン:** 画面左上固定。一覧画面へ戻る。
        
    - **ツールバー:** 画面左端・中央付近に縦並び固定。
        
        1. **ペン（デフォルト選択）**
            
        2. **消しゴム**
            
        3. **Undo**
            
        
        - ※ツールバーはZoom/Scrollの影響を受けず常に定位置に表示すること。
            

#### ツール詳細仕様

1. **ペンツール**
    
    - **色:** 不透明のピンク（例: `#FF69B4`, `opacity: 1.0`）。
        
    - **挙動:**
        
        - `pointerdown` (始点) 〜 `pointermove` (ドラッグ) で、始点と現在地を対角線とする長方形（ボーダーのみ等のプレビュー）を描画。
            
        - `pointerup` (終点) で確定し、塗りつぶされた長方形オブジェクトを生成。IndexedDBへ即時保存。
            
2. **消しゴムツール**
    
    - **挙動:** 既に配置されたマーカーをタップすると、そのマーカーを削除する。IndexedDBへ即時反映。
        
3. **Undoツール**
    
    - **挙動:** 直近の1回分の操作（マーカー追加 or 削除）を取り消す。
        
    - **制限:** 履歴は10回分保持。
        

### 4.4. 学習モード

- **画面構成:** 編集モードと同様（画像縦並び）。ツールバーは表示しない。
    
- **表示状態:**
    
    - 全てのマーカーが描画された状態で開始。
        
    - マーカーの初期状態は「不透明（隠れた状態）」。
        
- **操作体系:**
    
    - **指:** スクロール、ピンチイン・アウト。
        
    - **ペン:** マーカーのタップ操作のみ。
        
    - **戻るボタン:** 画面左上固定。一覧へ戻る。
        
- **タップ挙動:**
    
    - マーカーをペンでタップすると、そのマーカーのスタイルを `opacity: 0.3` (70%透過) に変更。
        
    - **制約:**
        
        - 一度透過したマーカーを再度タップしても状態は変化しない（再非表示にはしない）。
            
        - 透過状態は保存しない（画面を抜けるとリセット）。
            

### 4.5. 設定メニュー（ダイアログ）

- **トリガー:** 一覧画面カード内の設定ボタン。
    
- **機能:**
    
    - **タイトル編集:** テキストボックスで修正・保存。
        
    - **画像の追加・削除:**
        
        - 既存画像リストを表示し、個別削除ボタンを配置。
            
        - 新規画像追加ボタンを配置（末尾に追加）。
            
    - **デッキ削除:** 「この暗記セットを削除しますか？」の確認アラート後、データ削除。
        

---

## 5. 技術的留意点（コーディングエージェントへの指示）

### 5.1. ズームと座標系の管理

- **課題:** ピンチイン・アウト（Zoom）を行った際、ブラウザ標準のズーム機能を使うとUI（ツールバー）まで拡大・移動してしまう可能性がある。
    
- **解決策:**
    
    - HTMLのMetaタグで `user-scalable=no` を設定し、ブラウザ標準ズームを無効化する。
        
    - マーカーの描画には **SVG** を使用する。画像と同じ `viewBox` を設定することで、拡大縮小しても座標ズレを防ぐことができる。
        

### 5.2. Apple Pencil判定

- `pointerdown`, `pointermove`, `click` イベントにおいて、`event.pointerType` プロパティを確認する条件分岐を必ず入れること。
    
    - `event.pointerType === 'pen'` : 描画・消去・回答アクション
        
    - `event.pointerType === 'touch'` : パン・ズーム（自作実装用イベントへ）
        

### 5.3. PWA設定

- `manifest.json` を作成し、iPadのホーム画面に追加した際にアドレスバーが消える（スタンドアロンモード）ように設定すること。
    
- `display: "standalone"`
    
- `display: "standalone"`